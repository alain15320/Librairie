<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Document sans nom</title>
<link href="../css/base.css" rel="stylesheet" type="text/css">
</head>

<body>
<h1>Structure et sources</h1>
<p>La structure générale, la  classe <strong>ModeleClients</strong>, la classe <strong>ControleClient</strong> et les actions des boutons des panneaux PClients, et  la classe PClient sont reportées ci-dessous.</p>
<p>Voici la structure générale  des packages :</p>
<div>
  <div><img alt="images/12-15.png" src="images/images_12-15.png"></div>
</div>
<div>
  <h2>1. ModeleClients</h2>
  <p>Vous trouverez dans cette section le code  source de la classe <strong>ModeleClients</strong>.</p>
  <pre>package controle.modele;      /*    *  Classe comportant le modèle de données des Clients.    *  Doit étendre la classe abstraite AbstractTableModel    */      import java.time.Instant;   import java.util.ArrayList;   import java.util.List;      import javax.swing.table.AbstractTableModel;      import entite.Client;      public class ModeleClients extends AbstractTableModel {       private static final long serialVersionUID = 1L;          // représente les lignes du modèle       private final List&lt;Client&gt; lesDonnees;          // les en-têtes de colonnes       private static final String[] TITRES =        {"Code", "Nom", "Prénom", "Carte Fidélité", "Date Création"};          public ModeleClients(List&lt;Client&gt; lesClients) {           lesDonnees = new ArrayList&lt;&gt;(lesClients);       }              public int getRowCount() {           return lesDonnees.size();       }          public int getColumnCount() {           return TITRES.length;       }              public String getColumnName(int columnIndex) {           return TITRES[columnIndex];       }          // pour accéder à la valeur d’une cellule       public Object getValueAt(int rowIndex, int columnIndex) {           Client client = getClient(rowIndex);           switch(columnIndex){           case 0:               return client.getCode();           case 1:               return client.getNom();           case 2:               return client.getPrenom();           case 3:               return client.isCarteFidele();           case 4:               return client.getDateCreation();           default:               return null;           }       }              public Client getClient(int numeroLigne) {           return lesDonnees.get(numeroLigne);       }          /*        * utiles pour les renderers par défaut qui vont appliquer        * un style de présentation des données         * en fonction de la classe        */       @Override       public Class&lt;?&gt; getColumnClass(int columnIndex){           Class&lt;?&gt; classe = null;           switch(columnIndex){           case 3:               classe = Boolean.class;               break;           case 4:               classe = Instant.class;               break;           default:               classe = super.getColumnClass(columnIndex);               break;           }           return classe;       }          // pour obtenir le numéro de ligne à partir du code       // lors d’une recherche dans la liste       private int getNumLigne(String unCode) {           int numLigne = -1;              for (int idx = 0; idx &lt; lesDonnees.size(); ++idx) {               String code = lesDonnees.get(idx).getCode();               if(code.equals(unCode)) {                   numLigne = idx;                   break;               }           }                       return numLigne;               }              public void créé(Client leClient) {           lesDonnees.add(leClient);           int index = lesDonnees.size() -1;           fireTableRowsInserted(index, index);       }          public void supprimé(int indexLigne) {           lesDonnees.remove(indexLigne);           // notification de la suppression            // de la ligne indexLigne à la ligne indexLigne           fireTableRowsDeleted(indexLigne, indexLigne);       }          public void modifié(Client leClient) {           int numeroLigne = getNumLigne(leClient.getCode());           if (numeroLigne &gt;= 0) {                           lesDonnees.set(numeroLigne, leClient);               fireTableRowsUpdated(numeroLigne, numeroLigne);           }       }          /* permet de mettre à jour le modèle         * suite à de nouvelles recherches        * et d’informer les vues affichant ce modèle        */       public void lu(List&lt;Client&gt; nouvellesDonnees){           lesDonnees.clear();           lesDonnees.addAll(nouvellesDonnees);           fireTableDataChanged();       }   }  </pre>
</div>
<div>
  <h2>2. ControleClient</h2>
  <p>Vous trouverez dans cette section le code  source de la classe <strong>ControleClient</strong>.</p>
  <pre>package controle;      import java.beans.PropertyChangeListener;   import java.beans.PropertyChangeSupport;   import java.text.ParseException;   import java.time.Instant;   import java.util.Collections;   import java.util.List;      import javax.swing.JOptionPane;      import controle.connection.Connexion;   import controle.modele.ModeleClients;   import entite.Client;   import entite.crud.ClientCrud;      public class ControleClient {          private final ClientCrud crud;       private final ModeleClients leModeleClients;          private final PropertyChangeSupport notifications                        = new PropertyChangeSupport(this);              public void addPropertyChangeListener(                       PropertyChangeListener listener) {           this.notifications.addPropertyChangeListener(listener);       }          public void removePropertyChangeListener(                       PropertyChangeListener listener) {           notifications.removePropertyChangeListener(listener);       }          public ControleClient(Connexion connexion) {           crud = new ClientCrud(connexion);           List&lt;Client&gt; clients = null;           try {                clients = crud.lire();           } catch (Exception e){               JOptionPane.showMessageDialog(null,                    "Aucune lecture effectuée dans la BD.\n\n"                    +e.getMessage(),                   "Problème rencontré",                    JOptionPane.ERROR_MESSAGE);                       clients = Collections.emptyList();           }              leModeleClients = new ModeleClients(clients);       }          public ModeleClients getModele() {           return leModeleClients;       }          public Client creer(String code, String nom, String prenom,               boolean carte, Instant crééLe) {           if (crééLe == null ) {               crééLe = Instant.now();           }           // création d’une instance client pour obtenir le CRUD           Client leClient = new Client(code, nom, prenom,                               carte, crééLe);           try {               // 1. sauvegarde d’abord dans la BD               crud.creer(leClient);                  // 2. puis ajout dans le modèle               leModeleClients.créé(leClient);               return leClient;           } catch (Exception e) {               JOptionPane.showMessageDialog(                       null,                   "Aucune création effectuée dans la BD.\n\n"                   + e.getMessage(), "Problème rencontré",                   JOptionPane.ERROR_MESSAGE);           }              return null;       }          public boolean modifier(String code, String nom, String prenom,               boolean carteFidelite, Instant creation)                            throws ParseException {              // création d’une instance client pour abriter            // les données à modifier par le CRUD           Client leClient = new Client(code, nom, prenom,                           carteFidelite, creation);           try {               Client ancienClient = crud.lire(code);               // 1. sauvegarde d’abord dans la BD               leClient = crud.modifier(leClient);               notifications.firePropertyChange("client",                                   ancienClient,                                   leClient);               // 2. puis ajout dans le modèle                // --&gt; MAJ du JTable auto               if (leClient != null) {                   leModeleClients.modifié(leClient);                   return true;               }           } catch (Exception e) {               JOptionPane.showMessageDialog(                       null,               "Aucune modification effectuée dans la BD.\n\n"               + e.getMessage(), "Problème rencontré",               JOptionPane.ERROR_MESSAGE);           }           return false;       }          public void supprimer(int numeroLigne) {           Client client = leModeleClients.getClient(numeroLigne);           try {               crud.supprimer(client.getCode());                  // suppression de la ligne dans le modèle               leModeleClients.supprimé(numeroLigne);           } catch (Exception e) {               JOptionPane.showMessageDialog(                       null,               "Aucune suppression effectuée dans la BD.\n\n"               + e.getMessage(), "Problème rencontré",               JOptionPane.ERROR_MESSAGE);           }       }          public void rechercher(String code, String nom, String prenom) {          try {               List&lt;Client&gt; lus = crud.chercher(code, nom, prenom);               leModeleClients.lu(lus);           } catch (Exception e) {               JOptionPane.showMessageDialog(                       null,               "Aucune recherche effectuée dans la BD.\n\n"               + e.getMessage(), "Problème rencontré",               JOptionPane.ERROR_MESSAGE);           }       }          public void rechercher(String text) {           try {               List&lt;Client&gt; lus = crud.chercher(text);               leModeleClients.lu(lus);           } catch (Exception e) {               JOptionPane.showMessageDialog(                       null,               "Aucune recherche effectuée dans la BD.\n\n"               + e.getMessage(), "Problème rencontré",               JOptionPane.ERROR_MESSAGE);           }       }   }  </pre>
</div>
<div>
  <h2>3. PClients</h2>
  <p>Vous trouverez dans cette section le code  source de la classe <strong>PClients</strong>, définissant l’interface graphique  listant les clients.</p>
  <pre>public class PClients     extends JPanel                    implements TableModelListener {          private static final long serialVersionUID = 1L;          // propriétés non graphiques       // -------------------------       private ControleClient controleClient;       private Connexion connexion;          // propriétés graphiques       // -------------------------       private JTable table;       private JTextField txtCode;       private JTextField txtDateCreation;       private JTextField txtPrenom;       private JTextField txtNom;       private JTextField txtAdresse;       private JTextField txtTelfixe;       private JTextField txtMobile;       private JTextField txtEmail;          private JTextArea textArea;          private JCheckBox cartefidelite;          private final Action annuler = new ActionAnnuler();       private final Action actionAjouter = new ActionAjouter();       private final Action actionRechercher = new ActionRechercher();       private final Action actionModifier = new ActionModifier();       private final Action actionSupprimer = new ActionSupprimer();         private final Action actionAccueil = new ActionAccueil();             private JDialog fenetre;             private JButton btnModifier;             private JButton btnRechercher;             private JButton btnAjouter;          public PClients setConnexion(Connexion connexion) {           this.connexion = connexion;           controleClient = new ControleClient(connexion);              table.setModel(controleClient.getModele());           controleClient.getModele().addTableModelListener(this);           controleClient.addPropertyChangeListener(evt -&gt; {       System.out.println("Changement " +evt.getPropertyName());       System.out.println("Ancienne valeur " +evt.getOldValue());       System.out.println("Nouvelle valeur " +evt.getNewValue());           });           // gestion du rendu des colonnes du JTables           // ----------------------------------------           TableColumnModel modeleColonne = table.getColumnModel();           TableColumn noms = modeleColonne.getColumn(1);           noms.setCellRenderer(new GrasRenderer());           TableColumn cartes = modeleColonne.getColumn(3);           cartes.setCellRenderer(new BooleenRenderer());           TableColumn dates = modeleColonne.getColumn(4);           dates.setCellRenderer(new InstantRenderer());              table.addMouseListener(new MouseAdapter() {              public void mouseClicked(MouseEvent e) {                // gestion du simple clic sur une ligne de la table               // pour un report des données                // dans les champs correspondants                int numLigne = table.getSelectedRow();                if (numLigne &gt;= 0) {                    ModeleClients modele = controleClient.getModele();                  Client client = modele.getClient(numLigne);                  txtCode.setText(client.getCode());                  txtNom.setText(client.getNom());                  txtPrenom.setText(client.getPrenom());                  cartefidelite.setSelected(client.isCarteFidele());                  // on met la date de création au format dd-MM-yyyy                  String strDate =                        GestionDates.dateEnChaineFR(                           client.getDateCreation());                  txtDateCreation.setText(strDate);              }                 // gestion du double clic sur une ligne de la table              // pour une modif en mode fiche              if (e.getClickCount() == 2) {               modification();              }            }        });           return this;      }         public void setFenetre(JDialog fenetre) {          this.fenetre = fenetre;      }            private JDialog getFenetre() {          return fenetre;      }            private void changerPanneau(JPanel panneau, String titre) {          Window fenetre = getFenetre();          if (fenetre instanceof JDialog) {              JDialog dialogue = (JDialog) fenetre;              dialogue.setContentPane(panneau);              dialogue.setTitle(titre);           }           fenetre.revalidate();       }              private ImageIcon getImage(String image) {           return new ImageIcon(getClass().getResource(image));       }       ...    }  </pre>
  <pre>// méthode de modification appelée si clic sur Modification   // ou si double clic sur une ligne de la table   private void modification() {       int numeroLigne = table.getSelectedRow();       if (numeroLigne &lt; 0) {           // si aucune ligne sélectionnée           JOptionPane.showMessageDialog(null,                "Sélectionnez auparavant"               + " la ligne à modifier" + ’\n’               + "ou effectuez un double clic sur la ligne",               "MODIFICATION", JOptionPane.INFORMATION_MESSAGE);       } else {           // on récupère avant les données            // à partir d’une ligne sélectionnée           Client client =               controleClient.getModele().getClient(numeroLigne);              // on crée la fenêtre Fiche Client           PClient edition = new PClient(client) {                                  private static final long serialVersionUID = 1L;                  @Override               protected void configurerAction(                           AbstractAction action) {                   action.putValue(Action.NAME, "Modifier");                   action.putValue(Action.LARGE_ICON_KEY,                       getImage(                       "/images/gestion/Save-48.png"));               }                                  @Override               protected void actionPrincipale(String code,                                   String nom,                                   String prenom,                               boolean fidelite,                               Instant crééLe) {                   try {                       boolean modifié =                           controleClient.modifier(                               code, nom, prenom,                               fidelite, crééLe);                       if (modifié) {                          annuler.actionPerformed(null);                       }                   } catch (ParseException e) {                       e.printStackTrace();                   }               }           };           edition.getLblTitre().setText("Edition");           edition.getLblTitre().setIcon(getImage(               "/images/gestion/client/User-Modify-64.png"));           edition.setActionAnnuler(actionAnnuler);           edition.setActionExport(actionExport);                          btnModifier.setIcon(getImage(                   "/images/gestion/Data-Edit-48.png"));           changerPanneau(edition, "Modification du client "                           +client.getPrenom() +" "                            +client.getNom()                           +"["+client.getCode() +"]");       }   }  </pre>
  <pre>private class ActionAccueil extends AbstractAction {       private static final long serialVersionUID = 1L;       public ActionAccueil() {           putValue(NAME, "Accueil");           putValue(SHORT_DESCRIPTION,                        "Retourner sur l’écran d’accueil");       }          public void actionPerformed(ActionEvent e) {           getFenetre().dispose();       }   }  </pre>
  <pre>private class ActionAnnuler extends AbstractAction {       private static final long serialVersionUID = 1L;       public ActionAnnuler() {           putValue(NAME, "Annuler");           putValue(SHORT_DESCRIPTION,                       "Annuler l’action en cours");       }          public void actionPerformed(ActionEvent e) {           changerPanneau(PClients.this, "Gestion des Clients");       }   }  </pre>
  <pre>private class ActionSupprimer extends AbstractAction {       private static final long serialVersionUID = 1L;       public ActionSupprimer() {           putValue(NAME, "Supprimer");           putValue(SHORT_DESCRIPTION,                       "Supprimer le client sélectionné");       }          public void actionPerformed(ActionEvent e) {           int numeroLigne = table.getSelectedRow();           if (numeroLigne &lt; 0) {               // si aucune ligne sélectionnée               JOptionPane.showMessageDialog(null,                   "Sélectionnez une ligne avant.",                   "Suppression",                   JOptionPane.INFORMATION_MESSAGE);           } else {               int choix = JOptionPane.showConfirmDialog(                           null,                           String.format(                       "Voulez-vous supprimer "                       +"la fiche du client ?"                       + "\ncode : %s"                       + "\nnom  : %s",                       table.getValueAt(numeroLigne, 0),                       table.getValueAt(numeroLigne, 1)),                       "SUPPRESSION",                       JOptionPane.YES_NO_OPTION);               // 0 : oui 1 : non               if (choix == JOptionPane.YES_OPTION) {                   controleClient.supprimer(numeroLigne);               }           }       }   }  </pre>
  <pre>private class ActionModifier extends AbstractAction {       private static final long serialVersionUID = 1L;       public ActionModifier() {           putValue(NAME, "Modifier");           putValue(SHORT_DESCRIPTION,                        "Modifier le client sélectionné");       }          public void actionPerformed(ActionEvent e) {           modification();       }   }  </pre>
  <pre>private class ActionRechercher extends AbstractAction {       private static final long serialVersionUID = 1L;       public ActionRechercher() {           putValue(NAME, "Rechercher");           putValue(SHORT_DESCRIPTION,                        "Rechercher parmi les clients");       }          public void actionPerformed(ActionEvent e) {              // --- RECHERCHE EN MODE FICHE ---           // création de la fenêtre           PClientRecherche recherche = new PClientRecherche();           recherche.setActionAnnuler(actionAnnuler);           ControleClient controle = new ControleClient(connexion);           recherche.setControleClient(controle);              btnRechercher.setIcon(getImage(                       "/images/gestion/Search-48.png"));           changerPanneau(recherche, "Recherche de client(s)");       }   }  </pre>
  <pre>private class ActionAjouter extends AbstractAction {       private static final long serialVersionUID = 1L;          public ActionAjouter() {           putValue(NAME, "Ajouter");           putValue(SHORT_DESCRIPTION,                        "Ajouter un nouveau client");       }          public void actionPerformed(ActionEvent e) {           // --- AJOUT EN MODE FICHE ---           PClient ajout = new PClient();           ajout.setActionAnnuler(actionAnnuler);           ajout.setControleClient(controleClient);                          btnAjouter.setIcon(getImage(                       "/images/gestion/Add-New-48.png")));           changerPanneau(ajout ,"Ajouter un nouveau client");       }   }  </pre>
</div>
<div>
  <h2>4. PClient</h2>
  <p>Vous trouverez dans cette section le code  source de la classe <strong>PClient</strong>, permettant de visualiser un client donné.</p>
  <pre>public class PClient extends JPanel {          private static final long serialVersionUID = 1L;          // propriétés non graphiques       // -------------------------       private ControleClient controleClient;          // propriétés graphiques       // -------------------------       private JTextField txtCode;       private JFormattedTextField dateCreation;       private JTextField txtPrenom;       private JTextField txtNom;       private JTextField txtAdresse;       private JTextField txtTelfixe;       private JTextField txtMobile;       private JTextField txtEmail;          private JTextArea textArea;          private JCheckBox cartefidelite;          private final Action actionPrincipale = new ActionPrincipale();            private JLabel lblTitre;       private JTextField txtCodepostal;       private JTextField txtVille;          private JButton btnAccueil;          private final class Formateur extends               JFormattedTextField.AbstractFormatter {           private static final long serialVersionUID = 1L;              @Override           public String valueToString(Object value)                            throws ParseException {               String text = "";               if (value instanceof Instant) {                   Instant instant = (Instant) value;                       text =                    GestionDates.dateEnChaineFR(instant);               }               return text;           }              @Override           public Object stringToValue(String text)                            throws ParseException {               try {                   return                    GestionDates.chaineFRenDate(text);               } catch (ParseException e) {                   return null;               }           }       }          PClient setControleClient(ControleClient controleClient) {           this.controleClient = controleClient;           return this;       }          PClient(Client client) {              JFormattedTextField.AbstractFormatter formatter =                                new Formateur();           dateCreation = new JFormattedTextField(formatter);              createContents();           if (client != null) {               txtCode.setText(client.getCode());               // on empèche la modification                // des champs code et date création               txtCode.setEditable(false);               dateCreation.setValue(client.getDateCreation());               dateCreation.setEditable(false);                  txtNom.setText(client.getNom());               txtPrenom.setText(client.getPrenom());               cartefidelite.setSelected(client.isCarteFidele());           }       }       ...    }  </pre>
  <pre>private class ActionPrincipale extends AbstractAction {       private static final long serialVersionUID = 1L;          public ActionPrincipale() {           configurerAction(this);       }          public void actionPerformed(ActionEvent e) {           String code = txtCode.getText();           String nom = txtNom.getText();           String prenom = txtPrenom.getText();           boolean carteFidelite = cartefidelite.isSelected();           Instant crééLe = (Instant) dateCreation.getValue();              actionPrincipale(code, nom, prenom,                        carteFidelite, crééLe);       }   }      protected void configurerAction(AbstractAction action) {       action.putValue(AbstractAction.NAME, "Sauvegarder");       action.putValue(AbstractAction.SHORT_DESCRIPTION,                        "Sauvegarder le nouveau client");   }      protected void actionPrincipale(String code,                        String nom, String prenom,                       boolean fidelite, Instant crééLe) {       if (!code.equals("")) {           controleClient.creer(code, nom, prenom,                       fidelite, crééLe);              // remise à vide des champs pour un nouvel ajout           txtCode.setText("");           txtNom.setText("");           txtPrenom.setText("");           // on remet la date du jour par défaut           dateCreation.setValue(Instant.now());           cartefidelite.setSelected(false);              txtCode.requestFocus();       } else {           JOptionPane.showMessageDialog(null,                        "La saisie du code client"                       + " est obligatoire",                       "Vérifiez votre saisie",                       JOptionPane.ERROR_MESSAGE);       }   }      JLabel getLblTitre() {       return lblTitre;   }      void setActionAnnuler(Action action) {       btnAccueil.setAction(action);       UI.deshabillerBouton(btnAccueil, "Cancel");   }  </pre>
</div>
</body>
</html>
